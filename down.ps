//@version=6
// –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π —Ç–µ—Ä–Ω–∞—Ä–Ω—ã–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä—ã –∏ –Ω–µ –ø–µ—Ä–µ–Ω–æ—Å–∏ –Ω–∞ –Ω–æ–≤—ã–µ —Å—Ç—Ä–æ–∫–∏
// –ï—Å–ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–±—ä—è–≤–ª—è–µ—Ç—Å—è –≤ –ø–µ—Ä–≤—ã–π —Ä–∞–∑ —Ç–æ –ø—Ä–∏ –ø–æ–º–æ—â–∏ = –∞ –µ—Å–ª–∏ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π —á—Ç–æ-—Ç–æ –ø—Ä–∏—Å–≤–∞–∏–≤–∞–µ—Ç—Å—è —Ç–æ :=

indicator("JINADA Down üí∏", overlay=false, max_bars_back = 5000, max_boxes_count = 500)


// === === === === === === === === === === ===
// === === === –ë–ª–æ–∫ –∫–∞—Ä—Ç—ã –æ—Å—Ü–∏–ª—è—Ç–æ—Ä–æ–≤  === ===
// === === === === === === === === === === ===

// Inputs for Oscillator Map
oscMapGroup = "–ö–∞—Ä—Ç–∞ –æ—Å—Ü–∏–ª—è—Ç–æ—Ä–æ–≤"
showOscMap = input.bool(true, title="–ü–æ–∫–∞–∑–∞—Ç—å –∫–∞—Ä—Ç—É –æ—Å—Ü–∏–ª—è—Ç–æ—Ä–æ–≤", group=oscMapGroup, display=display.data_window)
osc_bull_color = input.color(#00e475, "–¶–≤–µ—Ç –±—ã—á–∏–π", group=oscMapGroup, display=display.data_window)
osc_bear_color = input.color(#ff5252, "–¶–≤–µ—Ç –º–µ–¥–≤–µ–∂–∏–π", group=oscMapGroup, display=display.data_window)
osc_neutral_color = input.color(color.gray, "–¶–≤–µ—Ç –Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π", group=oscMapGroup, display=display.data_window)
osc_label_bg_color = input.color(color.black, "–¶–≤–µ—Ç —Ñ–æ–Ω–∞ –ø–æ–¥–ø–∏—Å–∏", group=oscMapGroup, display=display.data_window)
osc_label_text_color = input.color(color.white, "–¶–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞ –ø–æ–¥–ø–∏—Å–∏", group=oscMapGroup, display=display.data_window)

// Momentum
momentum_val = ta.mom(close, 10)
momentum_heat_color = color.new(osc_bear_color, 100)
if momentum_val > 0
    momentum_heat_color := color.new(osc_bull_color, 0)
if momentum_val < 0
    momentum_heat_color := color.new(osc_bear_color, 0)
if math.abs(momentum_val) < 0.1
    momentum_heat_color := color.new(osc_neutral_color, 80)
plot(showOscMap ? -80 : na, color=momentum_heat_color, style=plot.style_area, linewidth=1, title="–¢–µ–ø–ª–æ–≤–∞—è –∫–∞—Ä—Ç–∞ Momentum", histbase=-84, display = display.pane)

// –ü–æ–¥–ø–∏—Å—å —Å–ø—Ä–∞–≤–∞ –æ—Ç –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∫–≤–∞–¥—Ä–∞—Ç–∏–∫–∞, –º–∞–ª–µ–Ω—å–∫–∞—è –∏ –ø–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω–∞—è, –±–µ–∑ —Ä–∞–º–∫–∏
var label momentum_label = na
if showOscMap and barstate.islast
    label.delete(momentum_label)
    momentum_label := label.new(x=bar_index + 1,y=-82,text="Momentum (" + str.tostring(momentum_val, format.mintick) + ")",color=color.new(osc_label_bg_color, 100), textcolor=color.new(osc_label_text_color, 60), style=label.style_label_left,size=size.small)
    label.set_textalign(momentum_label, text.align_left)


// CCI
cci_val = ta.cci(close, 20)
cci_overbought = 120
cci_oversold = -120
cci_heat_color = color.new(osc_bear_color, 100)
if cci_val > cci_overbought
    cci_heat_color := color.new(osc_bear_color, 0)
if cci_val < cci_oversold
    cci_heat_color := color.new(osc_bull_color, 0)
if cci_val >= -70 and cci_val <= -30
    cci_heat_color := color.new(osc_bull_color, 80)
if cci_val <= 70 and cci_val >= 30
    cci_heat_color := color.new(osc_bear_color, 80)
plot(showOscMap ? -84 : na, color=cci_heat_color, style=plot.style_area, linewidth=1, title="–¢–µ–ø–ª–æ–≤–∞—è –∫–∞—Ä—Ç–∞ CCI", histbase=-88, display = display.pane)

var label cci_label = na
if showOscMap and barstate.islast
    label.delete(cci_label)
    cci_label := label.new(x=bar_index + 1,y=-86,text="CCI (" + str.tostring(cci_val, format.percent) + ")",color=color.new(osc_label_bg_color, 100), textcolor=color.new(osc_label_text_color, 60), style=label.style_label_left,size=size.small)
    label.set_textalign(cci_label, text.align_left)


// Stochastic
stoch_k = ta.stoch(close, high, low, 14)
stoch_d = ta.sma(stoch_k, 3)
stoch_overbought = 90
stoch_overbought_half = 80
stoch_oversold = 10
stoch_oversold_half = 20
stoch_heat_color = color.new(osc_bear_color, 100)
if stoch_k > stoch_overbought
    stoch_heat_color := color.new(osc_bear_color, 0)
if stoch_k > stoch_overbought_half and stoch_k <= stoch_overbought
    stoch_heat_color := color.new(osc_bear_color, 80)
if stoch_k < stoch_oversold
    stoch_heat_color := color.new(osc_bull_color, 0)
if stoch_k < stoch_oversold_half and stoch_k >= stoch_oversold
    stoch_heat_color := color.new(osc_bull_color, 80)
plot(showOscMap ? -88 : na, color=stoch_heat_color, style=plot.style_area, linewidth=1, title="–¢–µ–ø–ª–æ–≤–∞—è –∫–∞—Ä—Ç–∞ Stoch", histbase=-92, display = display.pane)

var label stoch_label = na
if showOscMap and barstate.islast
    label.delete(stoch_label)
    stoch_label := label.new(x=bar_index + 1,y=-90,text="Stoch (" + str.tostring(stoch_k, format.percent) + ")",color=color.new(osc_label_bg_color, 100), textcolor=color.new(osc_label_text_color, 60), style=label.style_label_left,size=size.small)
    label.set_textalign(stoch_label, text.align_left)


// Stochastic RSI
rsi = ta.rsi(close, 14)
stochrsi_k = ta.stoch(rsi, rsi, rsi, 14)
stochrsi_d = ta.sma(stochrsi_k, 3)
stochrsi_overbought = 90
stochrsi_overbought_half = 80
stochrsi_oversold = 10
stochrsi_oversold_half = 20
stochrsi_heat_color = color.new(osc_bear_color, 100)
if stochrsi_k > stochrsi_overbought
    stochrsi_heat_color := color.new(osc_bear_color, 0)
if stochrsi_k > stochrsi_overbought_half and stochrsi_k <= stochrsi_overbought
    stochrsi_heat_color := color.new(osc_bear_color, 80)
if stochrsi_k < stochrsi_oversold
    stochrsi_heat_color := color.new(osc_bull_color, 0)
if stochrsi_k < stochrsi_oversold_half and stochrsi_k >= stochrsi_oversold
    stochrsi_heat_color := color.new(osc_bull_color, 80)
plot(showOscMap ? -92 : na, color=stochrsi_heat_color, style=plot.style_area, linewidth=1, title="–¢–µ–ø–ª–æ–≤–∞—è –∫–∞—Ä—Ç–∞ StochRSI", histbase=-96, display = display.pane)

var label stochrsi_label = na
if showOscMap and barstate.islast
    label.delete(stochrsi_label)
    stochrsi_label := label.new(x=bar_index + 1,y=-94,text="StochRSI (" + str.tostring(stochrsi_k, format.percent) + ")",color=color.new(osc_label_bg_color, 100), textcolor=color.new(osc_label_text_color, 60), style=label.style_label_left,size=size.small)
    label.set_textalign(stochrsi_label, text.align_left)


// RSI
rsi_overbought = 80
rsi_overbought_half = 60
rsi_oversold = 20
rsi_oversold_half = 40
rsi_heat_color = color.new(osc_bear_color, 100)
if rsi > rsi_overbought
    rsi_heat_color := color.new(osc_bear_color, 0)
if rsi > rsi_overbought_half and rsi <= rsi_overbought
    rsi_heat_color := color.new(osc_bear_color, 80)
if rsi < rsi_oversold
    rsi_heat_color := color.new(osc_bull_color, 0)
if rsi < rsi_oversold_half and rsi >= rsi_oversold
    rsi_heat_color := color.new(osc_bull_color, 80)
plot(showOscMap ? -96 : na, color=rsi_heat_color, style=plot.style_area, linewidth=1, title="–¢–µ–ø–ª–æ–≤–∞—è –∫–∞—Ä—Ç–∞ RSI", histbase=-100, display = display.pane)

var label rsi_label = na
if showOscMap and barstate.islast
    label.delete(rsi_label)
    rsi_label := label.new(x=bar_index + 1,y=-98,text="RSI (" + str.tostring(rsi, format.percent) + ")",color=color.new(osc_label_bg_color, 100), textcolor=color.new(osc_label_text_color, 60), style=label.style_label_left,size=size.small)
    label.set_textalign(rsi_label, text.align_left)


// MACD
macd_fast = 12
macd_slow = 26
macd_signal = 9
[macd_val, macd_signal_val, _] = ta.macd(close, macd_fast, macd_slow, macd_signal)
macd_hist = macd_val - macd_signal_val
macd_heat_color = color.new(osc_bear_color, 100)
if macd_hist > 0
    macd_heat_color := color.new(osc_bull_color, 0)
if macd_hist < 0
    macd_heat_color := color.new(osc_bear_color, 0)
if math.abs(macd_hist) < 0.1
    macd_heat_color := color.new(osc_neutral_color, 80)
plot(showOscMap ? -100 : na, color=macd_heat_color, style=plot.style_area, linewidth=1, title="–¢–µ–ø–ª–æ–≤–∞—è –∫–∞—Ä—Ç–∞ MACD", histbase=-104, display = display.pane)

var label macd_label = na
if showOscMap and barstate.islast
    label.delete(macd_label)
    macd_label := label.new(x=bar_index + 1,y=-102,text="MACD (" + str.tostring(macd_hist, format.percent) + ")",color=color.new(osc_label_bg_color, 100), textcolor=color.new(osc_label_text_color, 60), style=label.style_label_left,size=size.small)
    label.set_textalign(macd_label, text.align_left)



// === === === === === === === === === === === === === ===  === === ===
// === === === –ë–ª–æ–∫ —Å—Ç–æ—Ö–∞—Å—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–≥–æ –æ—Å—Ü–∏–ª—è—Ç–æ—Ä–∞ === === ===
// === === === === === === === === === === === === === ===  === === ===

csoGroup = "–¶–°–û"
displayMode = input.string(title="–†–µ–∂–∏–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è", defval="–û–±–∞", options=["–°—Ç–∞–Ω–¥–∞—Ä—Ç", "–ì–∏—Å—Ç–æ–≥—Ä–∞–º–º–∞", "–û–±–∞"], group=csoGroup, display=display.data_window)

periodK = input.int(14, title="–î–ª–∏–Ω–∞ %K", minval=1, group=csoGroup, display=display.data_window)
smoothK = input.int(8, title="–°–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ %K", minval=1, group=csoGroup, display=display.data_window)
periodD = input.int(3, title="–°–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ %D", minval=1, group=csoGroup, display=display.data_window)

lbL = input.int(5, title="–õ–µ–≤–æ", group=csoGroup, display=display.data_window, inline="1", tooltip="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–∞—Ä–æ–≤ —Å–ª–µ–≤–∞/—Å–ø—Ä–∞–≤–∞ –æ—Ç –ø–∏–≤–æ—Ç–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞ –¥–∏–≤–µ—Ä–≥–µ–Ω—Ü–∏–∏.")
lbR = input.int(5, title="–ü—Ä–∞–≤–æ", group=csoGroup, display=display.data_window, inline="1", tooltip="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–∞—Ä–æ–≤ —Å–ª–µ–≤–∞/—Å–ø—Ä–∞–≤–∞ –æ—Ç –ø–∏–≤–æ—Ç–∞ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.")
rangeLower = input.int(5, title="–ú–∏–Ω. –¥–∏–∞–ø–∞–∑–æ–Ω", group=csoGroup, display=display.data_window, inline="2")
rangeUpper = input.int(60, title="–ú–∞–∫—Å. –¥–∏–∞–ø–∞–∑–æ–Ω", group=csoGroup, display=display.data_window, inline="2", tooltip="–ú–∏–Ω/–º–∞–∫—Å –¥–∏–∞–ø–∞–∑–æ–Ω (–≤ –±–∞—Ä–∞—Ö) –æ—Ç –ø–∏–≤–æ—Ç–∞ –¥–ª—è –≤–∞–ª–∏–¥–Ω–æ–π –¥–∏–≤–µ—Ä–≥–µ–Ω—Ü–∏–∏.")
plotBull = input.bool(true, title="–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –±—ã—á—å–∏", group=csoGroup, display=display.data_window, inline="3")
plotHiddenBull = input.bool(true, title="–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —Å–∫—Ä—ã—Ç—ã–µ –±—ã—á—å–∏", group=csoGroup, display=display.data_window, inline="3")
plotBear = input.bool(true, title="–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –º–µ–¥–≤–µ–∂—å–∏", group=csoGroup, display=display.data_window, inline="4")
plotHiddenBear = input.bool(true, title="–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —Å–∫—Ä—ã—Ç—ã–µ –º–µ–¥–≤–µ–∂—å–∏", group=csoGroup, display=display.data_window, inline="4")

showHighsLows = input.bool(true, title="–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —ç–∫—Å—Ç—Ä–µ–º—É–º—ã", group=csoGroup, display=display.data_window)
lookbackPeriod = input.int(100, title="–ü–µ—Ä–∏–æ–¥ –ø–æ–∏—Å–∫–∞ —ç–∫—Å—Ç—Ä–µ–º—É–º–æ–≤", minval=1, tooltip="–°–∫–æ–ª—å–∫–æ –±–∞—Ä–æ–≤ –Ω–∞–∑–∞–¥ –∏—Å–∫–∞—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–π –º–∞–∫—Å–∏–º—É–º/–º–∏–Ω–∏–º—É–º", group=csoGroup, display=display.data_window) 

tradColours = input.bool(false, "–ù–µ–π—Ç—Ä–∞–ª—å–Ω—ã–µ —Å–≤–µ—á–∏", group=csoGroup, display=display.data_window)

// –¶–≤–µ—Ç–∞
grey = input.color(#98989810, "–°–µ—Ä—ã–π", group=csoGroup, display=display.data_window)
white = input.color(#FFFFFF00, "–ë–µ–ª—ã–π", group=csoGroup, display=display.data_window)
bearColour = input.color(#ec4343, "–ú–µ–¥–≤–µ–∂–∏–π", group=csoGroup, display=display.data_window)
bullColour = input.color(#3eb53e, "–ë—ã—á–∏–π", group=csoGroup, display=display.data_window)
noneColour = color.new(white,100)
textColour = input.color(#FFFFFFFF, "–¶–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞", group=csoGroup, display=display.data_window)
hiddenbearColour = color.new(bearColour, 80)
hiddenbullColour = color.new(bullColour, 80)

// –í—ã—á–∏—Å–ª–µ–Ω–∏—è
k = ta.sma(ta.stoch(close, high, low, periodK), smoothK)
d = ta.sma(k, periodD)
k_minus_d = k - d

osc = displayMode == "–°—Ç–∞–Ω–¥–∞—Ä—Ç" ? k : displayMode == "–û–±–∞" ? k-50 : na

// –ü–æ–∏—Å–∫ –ø–∏–≤–æ—Ç–æ–≤
plFound = na(ta.pivotlow(osc, lbL, lbR)) ? false : true
phFound = na(ta.pivothigh(osc, lbL, lbR)) ? false : true
_inRange(cond) =>
    bars = ta.barssince(cond == true)
    rangeLower <= bars and bars <= rangeUpper

// –û–±—ã—á–Ω–∞—è –±—ã—á—å—è –¥–∏–≤–µ—Ä–≥–µ–Ω—Ü–∏—è
oscHL = osc[lbR] > ta.valuewhen(plFound, osc[lbR], 1) and _inRange(plFound[1])
priceLL = low[lbR] < ta.valuewhen(plFound, low[lbR], 1)
bullCondAlert = priceLL and oscHL and plFound
bullCond = plotBull and bullCondAlert

// –°–∫—Ä—ã—Ç–∞—è –±—ã—á—å—è –¥–∏–≤–µ—Ä–≥–µ–Ω—Ü–∏—è
oscLL = osc[lbR] < ta.valuewhen(plFound, osc[lbR], 1) and _inRange(plFound[1])
priceHL = low[lbR] > ta.valuewhen(plFound, low[lbR], 1)
hiddenBullCondAlert = priceHL and oscLL and plFound
hiddenBullCond = plotHiddenBull and hiddenBullCondAlert

// –û–±—ã—á–Ω–∞—è –º–µ–¥–≤–µ–∂—å—è –¥–∏–≤–µ—Ä–≥–µ–Ω—Ü–∏—è
oscLH = osc[lbR] < ta.valuewhen(phFound, osc[lbR], 1) and _inRange(phFound[1])
priceHH = high[lbR] > ta.valuewhen(phFound, high[lbR], 1)
bearCondAlert = priceHH and oscLH and phFound
bearCond = plotBear and bearCondAlert

// –°–∫—Ä—ã—Ç–∞—è –º–µ–¥–≤–µ–∂—å—è –¥–∏–≤–µ—Ä–≥–µ–Ω—Ü–∏—è
oscHH = osc[lbR] > ta.valuewhen(phFound, osc[lbR], 1) and _inRange(phFound[1])
priceLH = high[lbR] < ta.valuewhen(phFound, high[lbR], 1)
hiddenBearCondAlert = priceLH and oscHH and phFound
hiddenBearCond = plotHiddenBear and hiddenBearCondAlert

// –¶–≤–µ—Ç –≥–∏—Å—Ç–æ–≥—Ä–∞–º–º—ã
newHigh = k_minus_d >= ta.highest(k_minus_d, lookbackPeriod)
newLow = k_minus_d <= ta.lowest(k_minus_d, lookbackPeriod)
histColor = newHigh ? bullColour : newLow ? bearColour : color.new(white, 60)

// –û—Ç—Ä–∏—Å–æ–≤–∫–∞
kLine = plot(displayMode == "–°—Ç–∞–Ω–¥–∞—Ä—Ç" ? k : displayMode == "–û–±–∞" ? k-50 : na, title="%K", color=grey, display=display.pane)
dLine = plot(displayMode == "–°—Ç–∞–Ω–¥–∞—Ä—Ç" ? d : displayMode == "–û–±–∞" ? d-50 : na, title="%D", color=white, display=display.pane)
//hPlot = plot(displayMode == "–ì–∏—Å—Ç–æ–≥—Ä–∞–º–º–∞" or displayMode == "–û–±–∞" ? k_minus_d : na, title="Stoch –ì–∏—Å—Ç–æ–≥—Ä–∞–º–º–∞", color=histColor, style=plot.style_histogram, display=display.pane)
fill(kLine, dLine, color=k > d ? bullColour : bearColour)
bgcolor(showHighsLows and k >= ta.highest(k, lookbackPeriod) ? color.new(color.red, 90) : na)
bgcolor(showHighsLows and k <= ta.lowest(k, lookbackPeriod) ? color.new(color.blue, 90) : na)

plot(plFound ? osc[lbR] : na, offset=-lbR, title="–û–±—ã—á–Ω–∞—è –±—ã—á—å—è", linewidth=2, color=(bullCond ? #9512a9 : noneColour), display=display.pane)
//plotshape(bullCond ? osc[lbR] : na, offset=-lbR, title="–ú–µ—Ç–∫–∞ –±—ã—á—å—è", text=" –ë—ã–∫ ", style=shape.labelup, location=location.absolute, color=bullColour, textcolor=textColour, display=display.pane)

plot(plFound ? osc[lbR] : na, offset=-lbR, title="–°–∫—Ä—ã—Ç–∞—è –±—ã—á—å—è", linewidth=2, color=(hiddenBullCond ? #9512a9 : noneColour), display=display.pane)
//plotshape(hiddenBullCond ? osc[lbR] : na, offset=-lbR, title="–ú–µ—Ç–∫–∞ —Å–∫—Ä—ã—Ç–∞—è –±—ã—á—å—è", text=" –°–∫—Ä. –ë—ã–∫ ", style=shape.labelup, location=location.absolute, color=bullColour, textcolor=textColour, display=display.pane)

plot(phFound ? osc[lbR] : na, offset=-lbR, title="–û–±—ã—á–Ω–∞—è –º–µ–¥–≤–µ–∂—å—è", linewidth=2, color=(bearCond ? #9512a9 : noneColour), display=display.pane)
//plotshape(bearCond ? osc[lbR] : na, offset=-lbR, title="–ú–µ—Ç–∫–∞ –º–µ–¥–≤–µ–∂—å—è", text=" –ú–µ–¥–≤–µ–¥—å ", style=shape.labeldown, location=location.absolute, color=bearColour, textcolor=textColour, display=display.pane)

plot(phFound ? osc[lbR] : na, offset=-lbR, title="–°–∫—Ä—ã—Ç–∞—è –º–µ–¥–≤–µ–∂—å—è", linewidth=2, color=(hiddenBearCond ? #9512a9 : noneColour), display=display.pane)
//plotshape(hiddenBearCond ? osc[lbR] : na, offset=-lbR, title="–ú–µ—Ç–∫–∞ —Å–∫—Ä—ã—Ç–∞—è –º–µ–¥–≤–µ–∂—å—è", text=" –°–∫—Ä. –ú–µ–¥–≤–µ–¥—å ", style=shape.labeldown, location=location.absolute, color=bearColour, textcolor=textColour, display=display.pane)

highValue = displayMode == "–°—Ç–∞–Ω–¥–∞—Ä—Ç" ? ta.highest(k, lookbackPeriod) : displayMode == "–ì–∏—Å—Ç–æ–≥—Ä–∞–º–º–∞" ? ta.highest(k_minus_d, lookbackPeriod) : ta.highest(k, lookbackPeriod)-50
lowValue = displayMode == "–°—Ç–∞–Ω–¥–∞—Ä—Ç" ? ta.lowest(k, lookbackPeriod) : displayMode == "–ì–∏—Å—Ç–æ–≥—Ä–∞–º–º–∞" ? ta.lowest(k_minus_d, lookbackPeriod) : ta.lowest(k, lookbackPeriod)-50
midValue = displayMode == "–°—Ç–∞–Ω–¥–∞—Ä—Ç" ? 50 : 0

//plot(highValue, "–ú–∞–∫—Å–∏–º—É–º", color=grey, display=display.pane)
//plot(lowValue, "–ú–∏–Ω–∏–º—É–º", color=grey, display=display.pane)
//plot(midValue, "–°–µ—Ä–µ–¥–∏–Ω–∞", color=white, display=display.pane)

barcolor(tradColours ? close > open ? white : grey : na)






// === === === === === === === === === === === === === ===
// === === === –ë–ª–æ–∫ SmartRSI === === === === === === === ===
// === === === === === === === === === === === === === === ===

//Inputs
my_rsi_source = input.source(close, title="–ò—Å—Ç–æ—á–Ω–∏–∫ RSI", group="SmartRSI", display=display.data_window)
my_rsi_length = input.int(6, title="–î–ª–∏–Ω–∞ RSI", group="SmartRSI", display=display.data_window)
my_ma_length = input.int(2, title="–î–ª–∏–Ω–∞ –∫–æ—Ä–æ—Ç–∫–æ–π MA", group="SmartRSI", display=display.data_window)
my_rsi_smooth_length = input.int(7, title="–î–ª–∏–Ω–∞ —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏—è RSI", group="SmartRSI", display=display.data_window)
my_long_ma_length = input.int(60, title="–î–ª–∏–Ω–∞ –¥–ª–∏–Ω–Ω–æ–π MA", group="SmartRSI", display=display.data_window)
my_long_ma_on = input.bool(true, title="–í–∫–ª—é—á–∏—Ç—å –¥–ª–∏–Ω–Ω—É—é MA", group="SmartRSI", display=display.data_window)
my_signals_on = input.bool(true, title="–í–∫–ª—é—á–∏—Ç—å —Å–∏–≥–Ω–∞–ª—ã –±—ã–∫/–º–µ–¥–≤–µ–¥—å", group="SmartRSI", display=display.data_window)

// === –¶–≤–µ—Ç–∞ ===
color_bull = input.color(#3eb43eAA, "–¶–≤–µ—Ç –±—ã—á–∏–π", group="SmartRSI", display=display.data_window)
color_bear = input.color(#ec4343AA, "–¶–≤–µ—Ç –º–µ–¥–≤–µ–∂–∏–π", group="SmartRSI", display=display.data_window)
color_neutral = input.color(color.blue, "–¶–≤–µ—Ç –Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π", group="SmartRSI", display=display.data_window)
color_ma_bull = input.color(#00e67600, "–¶–≤–µ—Ç MA –±—ã—á–∏–π", group="SmartRSI", display=display.data_window)
color_ma_bear = input.color(#ff525200, "–¶–≤–µ—Ç MA –º–µ–¥–≤–µ–∂–∏–π", group="SmartRSI", display=display.data_window)
color_long_ma_bull = input.color(color.new(color.lime, 20), "–¶–≤–µ—Ç –¥–ª–∏–Ω–Ω–æ–π MA –±—ã—á–∏–π", group="SmartRSI", display=display.data_window)
color_long_ma_bear = input.color(color.new(color.red, 20), "–¶–≤–µ—Ç –¥–ª–∏–Ω–Ω–æ–π MA –º–µ–¥–≤–µ–∂–∏–π", group="SmartRSI", display=display.data_window)
color_mid_line = input.color(color.white, "–¶–≤–µ—Ç —Å—Ä–µ–¥–Ω–µ–π –ª–∏–Ω–∏–∏", group="SmartRSI", display=display.data_window)
color_mid_line := color.new(color_mid_line, 80)
color_res_line = input.color(#00bcd400, "–¶–≤–µ—Ç –ª–∏–Ω–∏–∏ 20/80", group="SmartRSI", display=display.data_window)
color_table_bg = input.color(#00000000, "–¶–≤–µ—Ç —Ñ–æ–Ω–∞ —Ç–∞–±–ª–∏—Ü—ã", group="SmartRSI", display=display.data_window)
color_table_text = input.color(color.white, "–¶–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞ —Ç–∞–±–ª–∏—Ü—ã", group="SmartRSI", display=display.data_window)
color_fill_bull = input.color(#3eb43e77, "–¶–≤–µ—Ç –∑–∞–ª–∏–≤–∫–∏ –±—ã—á–∏–π", group="SmartRSI", display=display.data_window)
color_fill_bear = input.color(#ec434377, "–¶–≤–µ—Ç –∑–∞–ª–∏–≤–∫–∏ –º–µ–¥–≤–µ–∂–∏–π", group="SmartRSI", display=display.data_window)
color_fill_bull_trans = input.color(#3eb43e25, "–¶–≤–µ—Ç –∑–∞–ª–∏–≤–∫–∏ –±—ã—á–∏–π –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π", group="SmartRSI", display=display.data_window)
color_fill_bear_trans = input.color(#ec434325, "–¶–≤–µ—Ç –∑–∞–ª–∏–≤–∫–∏ –º–µ–¥–≤–µ–∂–∏–π –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π", group="SmartRSI", display=display.data_window)

//RSI
my_rsi = ta.rsi(my_rsi_source, my_rsi_length)
my_smooth_rsi = ta.sma(my_rsi, my_rsi_smooth_length)

//Moving Average
my_ma = ta.rma(my_smooth_rsi, my_ma_length)

//Long Moving Average
my_long_ma = ta.sma(my_smooth_rsi, my_long_ma_length)
my_long_ma := my_long_ma * 2 - 100
red_color = input.color(color.red, "–¶–≤–µ—Ç –∫—Ä–∞—Å–Ω—ã–π", group="SmartRSI", display=display.data_window)
green_color = input.color(color.green, "–¶–≤–µ—Ç –∑–µ–ª—ë–Ω—ã–π", group="SmartRSI", display=display.data_window)
white_color = color.white
min_ma = -15
max_ma = 20
ma_norm = math.max(math.min((my_long_ma - min_ma) / (max_ma - min_ma), 1), 0)

// –ì—Ä–∞–¥–∏–µ–Ω—Ç: 0 = –∫—Ä–∞—Å–Ω—ã–π, 0.5 = –±–µ–ª—ã–π, 1 = –∑–µ–ª–µ–Ω—ã–π
float t = ma_norm
float r = t < 0.5 ? 255 : int(255 * (1 - (t - 0.5) * 2))
float g = t < 0.5 ? int(255 * (t * 2)) : 255
float b = t < 0.5 ? int(255 * (t * 2)) : 150

my_long_ma_color = color.rgb(int(r), int(g), int(b), 0)
plotshape(my_long_ma, title="RSI Line", style=shape.circle, location=location.absolute, color=my_long_ma_color, size=size.small)
//=//=//=//=//=//=//=//=//=//=//=//=//=//=//=

//Plot RSI & Mid Line
my_ma_line = plot(my_ma - 50, title="MA Line", color=my_smooth_rsi > my_ma ? color_ma_bull : color_ma_bear, linewidth=1, style=plot.style_line, display = display.pane)
my_rsi_line = plot(my_smooth_rsi - 50, title="RSI Line", color=my_smooth_rsi > my_ma ? color_ma_bull : color_ma_bear, linewidth=1, style=plot.style_line, display = display.pane)

//my_long_ma_plot = plot(my_long_ma, title="Long MA Line", color=my_smooth_rsi > my_long_ma ? color_long_ma_bull : color_long_ma_bear, linewidth=2, style=plot.style_line)
my_mid_line = plot(0, "Mid Line", color_mid_line, display = display.pane)
my_res_line = plot(-30, "20 Line", color_res_line, display = display.pane)
my_sup_line = plot(30, "80 Line", color_res_line, display = display.pane)
my_ma_signal_up = ta.crossover(my_smooth_rsi, my_long_ma)
my_ma_signal_down = ta.crossunder(my_smooth_rsi, my_long_ma)

//Background Fill
fill(my_rsi_line, my_ma_line, color = my_smooth_rsi > my_ma ? color_fill_bull : color_fill_bear, title = "Color Fill RSI Line To MA Line")
fill(my_ma_line, my_mid_line, color = my_ma < my_smooth_rsi and my_ma >= 50 ? color_fill_bull_trans : na, title = "Color Fill MA Line To Mid Line Above Mid Line")
fill(my_rsi_line, my_mid_line, color = my_ma > my_smooth_rsi and my_smooth_rsi >= 50 ? color_fill_bull_trans : na, title = "Color Fill RSI Line To Mid Line Above Mid Line")
fill(my_rsi_line, my_mid_line, color = my_ma < my_smooth_rsi and my_smooth_rsi < 50 ? color_fill_bear_trans : na, title = "Color Fill RSI Line To Mid Line Below Mid Line")
fill(my_ma_line, my_mid_line, color = my_ma > my_smooth_rsi and my_ma < 50 ? color_fill_bear_trans : na, title = "Color Fill MA Line To Mid Line Below Mid Line")

//Buy/Sell RSI
my_sell = my_smooth_rsi < my_ma
my_buy = my_smooth_rsi > my_ma

//Label Info
my_label_color = color.new(#000000, 0)
my_label_text = ""
my_label_color2 = color.new(#000000, 0)
my_label_text2 = ""

//Label Info Logic
if my_buy
    my_label_color := color_long_ma_bull
    my_label_text := string("Bullish RSI")
else if my_sell
    my_label_color := color_long_ma_bear
    my_label_text := string("Bearish RSI")
else
    my_label_color := color_neutral
    my_label_text := string("Neutral RSI")
    
//Second Label Logic
if my_smooth_rsi > my_long_ma and my_ma > my_long_ma and my_long_ma_on
    my_label_color2 := color_long_ma_bull
    my_label_text2 := string("Above Long MA")
else if my_smooth_rsi < my_long_ma and my_ma < my_long_ma and my_long_ma_on
    my_label_color2 := color_long_ma_bear
    my_label_text2 := string("Below Long MA")






// === === === === === === === === === === ===
// === === –ë–ª–æ–∫ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∫–∏—Ç–æ–≤   === === ===
// === === === === === === === === === === ===

// === Whale Activity Waves ===

whaleGroup = "–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∫–∏—Ç–æ–≤"
whale_vol_mult = input.float(2.5, "–ú–Ω–æ–∂–∏—Ç–µ–ª—å –æ–±—ä—ë–º–∞ –∫–∏—Ç–∞", group=whaleGroup, display=display.data_window)
whale_vol_len = input.int(30, "–ü–µ—Ä–∏–æ–¥ –æ–±—ä—ë–º–∞ –∫–∏—Ç–∞", group=whaleGroup, display=display.data_window)
whale_wave_color = color.new(#a020f0, 0) // –§–∏–æ–ª–µ—Ç–æ–≤—ã–π

whale_wave_top_value = input.int(80, "–í–µ—Ä—Ö–Ω—è—è –≥—Ä–∞–Ω–∏—Ü–∞ –≤–æ–ª–Ω—ã –∫–∏—Ç–∞", group=whaleGroup, display=display.data_window)
whale_wave_bottom_value = input.int(-140, "–ù–∏–∂–Ω—è—è –≥—Ä–∞–Ω–∏—Ü–∞ –≤–æ–ª–Ω—ã –∫–∏—Ç–∞", group=whaleGroup, display=display.data_window)
whale_wave_amplitude = input.int(11, "–ê–º–ø–ª–∏—Ç—É–¥–∞ –≤–æ–ª–Ω—ã –∫–∏—Ç–∞ (–º–∞–∫—Å. –≤—ã—Å–æ—Ç–∞)", group=whaleGroup, display=display.data_window)
whale_wave_threshold = input.float(0, "–ü–æ—Ä–æ–≥ —Å–∏–ª—ã –≤–æ–ª–Ω—ã –∫–∏—Ç–∞", group=whaleGroup, display=display.data_window) // –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å–∏–ª–∞ –≤–æ–ª–Ω—ã –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è

// === –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–∞—Ä–∞ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è ===
accum_bar_color = color.new(color.yellow, 40)
accum_bar_max_height = input.int(4, "–ú–∞–∫—Å. –≤—ã—Å–æ—Ç–∞ –±–∞—Ä–∞ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è", group=whaleGroup, display=display.data_window)
accum_bar_threshold = input.float(5, "–ü–æ—Ä–æ–≥ —Å–∏–ª—ã –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è", group=whaleGroup, display=display.data_window) // –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å–∏–ª–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –±–∞—Ä–∞

avg_vol = ta.sma(volume, whale_vol_len)
avg_range = ta.sma(high - low, whale_vol_len)

// === –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ–π (—Å–≤–µ—Ä—Ö—É –≤–Ω–∏–∑, —Ç–æ–ª—å–∫–æ –∑–µ–ª—ë–Ω—ã–µ —Å–≤–µ—á–∏) ===
is_green_candle = close > open
is_red_candle = close < open

// === –§–∞–∑—ã –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è –∫–∏—Ç–∞–º–∏ ===
// –ü–æ–∫—É–ø–∫–∏: –∫—Ä—É–ø–Ω—ã–π –æ–±—ä–µ–º, –º–∞–ª–µ–Ω—å–∫–∞—è —Å–≤–µ—á–∞, –∑–µ–ª–µ–Ω–∞—è —Å–≤–µ—á–∞
accum_buy_strength = is_green_candle ? math.min(volume / avg_vol * (avg_range / (high - low)), 2) : 0
accum_buy_bar_height = accum_buy_strength * accum_bar_max_height
accum_buy_bar_value = accum_buy_bar_height >= accum_bar_threshold ? whale_wave_top_value - accum_buy_bar_height : na

plot(accum_buy_bar_value, title="Accumulation Buy Bar", color=accum_bar_color, style=plot.style_columns, linewidth=3, histbase=whale_wave_top_value, display = display.pane)

// –ü—Ä–æ–¥–∞–∂–∏: –∫—Ä—É–ø–Ω—ã–π –æ–±—ä–µ–º, –º–∞–ª–µ–Ω—å–∫–∞—è —Å–≤–µ—á–∞, –∫—Ä–∞—Å–Ω–∞—è —Å–≤–µ—á–∞
accum_sell_strength = is_red_candle ? math.min(volume / avg_vol * (avg_range / (high - low)), 2) : 0
accum_sell_bar_height = accum_sell_strength * accum_bar_max_height
accum_sell_bar_value = accum_sell_bar_height >= accum_bar_threshold ? whale_wave_bottom_value + accum_sell_bar_height : na

plot(accum_sell_bar_value, title="Accumulation Sell Bar", color=accum_bar_color, style=plot.style_columns, linewidth=3, histbase=whale_wave_bottom_value, display = display.pane)

whale_buy_active = (volume > avg_vol * whale_vol_mult or close > ta.highest(close, whale_vol_len) or (high - low) > avg_range * whale_vol_mult) and is_green_candle
whale_buy_strength = whale_buy_active ? math.min((volume - avg_vol) / avg_vol, 2) : 0
whale_buy_wave_size = whale_buy_strength * whale_wave_amplitude
whale_buy_wave = whale_buy_wave_size >= whale_wave_threshold ? whale_wave_top_value - whale_buy_wave_size : na

top_base_plot = plot(whale_wave_top_value, title="Whale Top Base", color=color.new(whale_wave_color, 90), style=plot.style_area, linewidth=1, histbase=whale_wave_top_value, display = display.pane)
top_wave_plot = plot(whale_buy_wave, title="Whale Buy Wave", color=whale_buy_wave != whale_wave_top_value ? #a020f080 : #00000000, style=plot.style_area, linewidth=2, histbase=whale_wave_top_value, display = display.pane)
fill(top_base_plot, top_wave_plot, whale_wave_top_value - 1, whale_wave_top_value - whale_wave_amplitude, #a020f000, #a020f090, title = "Color Gradient Fill")

// === –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø—Ä–æ–¥–∞–≤—Ü–æ–≤ (—Å–Ω–∏–∑—É –≤–≤–µ—Ä—Ö, —Ç–æ–ª—å–∫–æ –∫—Ä–∞—Å–Ω—ã–µ —Å–≤–µ—á–∏) ===

whale_sell_active = (volume > avg_vol * whale_vol_mult or close < ta.lowest(close, whale_vol_len) or (high - low) > avg_range * whale_vol_mult) and is_red_candle
whale_sell_strength = whale_sell_active ? math.min((volume - avg_vol) / avg_vol, 2) : 0
whale_sell_wave_size = whale_sell_strength * whale_wave_amplitude
whale_sell_wave = whale_sell_wave_size >= whale_wave_threshold ? whale_wave_bottom_value + whale_sell_wave_size : na

bottom_base_plot = plot(whale_wave_bottom_value, title="Whale Bottom Base", color=color.new(whale_wave_color, 90), style=plot.style_line, linewidth=1, histbase=whale_wave_bottom_value, display = display.pane)
bottom_wave_plot = plot(whale_sell_wave, title="Whale Sell Wave", color=whale_sell_wave != whale_wave_bottom_value ? #a020f080 : #00000000, style=plot.style_line, linewidth=1, histbase=whale_wave_bottom_value, display = display.pane)
fill(bottom_base_plot, bottom_wave_plot, whale_wave_bottom_value + 1, whale_wave_bottom_value + whale_wave_amplitude, #a020f000, #a020f090, title = "Color Gradient Fill")